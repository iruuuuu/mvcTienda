<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Blog</title>
</head>
<body>
    <h1>Mi Blog</h1>
    
    <?php if (isset($_SESSION['user']) && is_object($_SESSION['user'])): ?>
        <p>Hola, <?php echo $_SESSION['user']->getUsername(); ?>
        <?php if ($_SESSION['user']->isAdmin()): ?>
            <strong>(Administrador)</strong>
        <?php endif; ?>
        </p>
        <a href="index.php?c=post&action=create">Nueva Publicación</a>
        <a href="index.php?c=user&logout=1">Salir</a>
    <?php else: ?>
        <a href="index.php?c=user">Iniciar Sesión</a>
    <?php endif; ?>

    <hr>

    <h2>Publicaciones</h2>
    <?php 
    if (!isset($product)) {
        $product = [];
    }
    ?>
    
    <?php if (count($posts) > 0): ?>
        <?php foreach ($posts as $post): ?>
            <div style="border: 1px solid #6c6c6cff; padding: 10px; margin: 10px 0;">
                <h3><?php echo htmlspecialchars($post->getTitle()); ?></h3>
                <p><strong>Por:</strong> <?php echo htmlspecialchars($post->getAuthor()); ?> 
                   <strong>Fecha:</strong> <?php echo date('d/m/Y H:i', strtotime($post->getCreatedAt())); ?></p>
                <p><?php echo nl2br(htmlspecialchars($post->getText())); ?></p>
                
                <?php 
                if (isset($_SESSION['user']) && is_object($_SESSION['user'])): 
                    if ($_SESSION['user']->isAdmin() || $post->getUserId() == $_SESSION['user']->getId()):
                ?>
                    <a href="index.php?delete=<?php echo $post->getId(); ?>" 
                       onclick="return confirm('¿Estás seguro de eliminar esta publicación?')">
                       [Eliminar Post]
                    </a>
                <?php 
                    endif;
                endif; 
                ?>

                <hr>
                <h4>Comentarios:</h4>
                <?php 
                $comments = isset($postComments[$post->getId()]) ? $postComments[$post->getId()] : [];
                if (count($comments) > 0): 
                ?>
                    <?php foreach ($comments as $comment): ?>
                        <div style="margin-left: 20px; padding: 5px; border-left: 2px solid #ddd;">
                            <p><strong><?php echo htmlspecialchars($comment->getUsername()); ?>:</strong> 
                               <?php echo htmlspecialchars($comment->getTexto()); ?></p>
                            <small><?php echo date('d/m/Y H:i', strtotime($comment->getFechaCreacion())); ?></small>
                            
                            <?php 
                            if (isset($_SESSION['user']) && is_object($_SESSION['user'])): 
                                if ($_SESSION['user']->isAdmin() || $comment->getUserId() == $_SESSION['user']->getId()):
                            ?>
                                <a href="index.php?delete_comment=<?php echo $comment->getId(); ?>" 
                                   onclick="return confirm('¿Estás seguro de eliminar este comentario?')">
                                   [Eliminar]
                                </a>
                            <?php 
                                endif;
                            endif; 
                            ?>
                        </div>
                    <?php endforeach; ?>
                <?php else: ?>
                    <p style="margin-left: 20px;"><em>No hay comentarios aún.</em></p>
                <?php endif; ?>

                <?php if (isset($_SESSION['user']) && is_object($_SESSION['user'])): ?>
                    <form method="POST" action="index.php?c=comment" style="margin-top: 10px;">
                        <input type="hidden" name="post_id" value="<?php echo $post->getId(); ?>">
                        <textarea name="comment_text" placeholder="Escribe un comentario..." required></textarea><br>
                        <button type="submit">Comentar</button>
                    </form>
                <?php endif; ?>
            </div>
        <?php endforeach; ?>
    <?php else: ?>
        <p>No hay publicaciones aún.</p>
    <?php endif; ?>
</body>
</html>
